<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì› ë“±ë¡ ë° ìˆ˜ì •</title>
</head>
<body>

<!-- íƒ­ ë²„íŠ¼ -->
<div style="margin-bottom: 20px;">
    <button type="button" onclick="showTab('tab1')">ì¸ì ì‚¬í•­</button>
    <button type="button" onclick="showTab('tab2')">ê²½ë ¥ ë° í•™ë ¥</button>
    <button type="button" onclick="showTab('tab3')">ì—°ë´‰ ë° ê³„ì¢Œì •ë³´</button>
</div>

<div style="display: flex;">
    <!-- ì¢Œì¸¡: ë“±ë¡ëœ ì‚¬ì› ë¦¬ìŠ¤íŠ¸ -->
    <div style="width: 35%; border-right: 1px solid #ccc; padding-right: 20px;">
        <a href="{% url 'home' %}">â† ë©”ì¸ìœ¼ë¡œ</a><br>
        <a href="{% url 'employee_list' %}">ì‚¬ì› ëª…ë¶€ ë³´ê¸°</a>
        <br><hr><br>
        <a href="{% url 'register' %}" style="font-weight: bold; color: green;">â• ì‹ ê·œ ì‚¬ì› ë“±ë¡</a>
        
        <hr>
        <!-- âœ… ê²€ìƒ‰ì°½ ì¶”ê°€ -->
        <form method="get" action="{% url 'register' %}" style="margin-bottom: 10px;">
            <input type="text" name="search" placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" value="{{ request.GET.search }}" style="width: 100%;">
            <button type="submit" style="margin-top: 5px;">ğŸ” ê²€ìƒ‰</button>
        </form>

        <h3>ë“±ë¡ëœ ì‚¬ì›</h3>
        <ul>
            {% for emp in employees %}
                <li>
                    <a href="{% url 'register_with_pk' emp.pk %}">{{ emp.employee_id }} - {{ emp.name }}</a>
                </li>
            {% empty %}
                <li>ë“±ë¡ëœ ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- ìš°ì¸¡: íƒ­ë³„ í¼ ì…ë ¥ ì˜ì—­ -->
    <div style="width: 65%; padding-left: 20px;">
        <h3>{% if form.instance.pk %}ì‚¬ì› ìˆ˜ì •{% else %}ì‚¬ì› ë“±ë¡{% endif %}</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- íƒ­1: ì¸ì ì‚¬í•­ -->
            <div id="tab1" class="tab-content" style="display: block;">
                <div style="display: flex; align-items: flex-start; gap: 20px;">
                    
                    <!-- ì˜¤ë¥¸ìª½: ì‚¬ì§„ ì—…ë¡œë“œ ì˜ì—­ -->
                    <div style="width: 140px; display: flex; flex-direction: column; align-items: center;">
                        {% if employee.photo %}
                            <img id="preview" src="{{ employee.photo.url }}" style="max-height: 140px; display: block; margin-bottom: 8px;">
                        {% else %}
                            <img id="preview" style="max-height: 140px; display: none; margin-bottom: 8px;">
                        {% endif %}

                        <!-- ìˆ¨ê²¨ì§„ input -->
                        <input type="file" name="photo" id="photo_input" accept="image/*" style="display: none;">

                        <!-- ë²„íŠ¼: ì‚¬ì§„ ì„ íƒ -->
                        <label for="photo_input"
                            style="cursor: pointer; background: #eee; padding: 6px 10px; border: 1px solid #aaa;
                                    width: 80%; text-align: center; box-sizing: border-box;">
                            ğŸ“ ì‚¬ì§„ ì„ íƒ
                        </label>

                        <!-- ì‚­ì œ ë§í¬ -->
                        {% if form.instance.pk and form.instance.photo %}
                            <div style="margin-top: 6px;">
                                <a href="{% url 'delete_photo' form.instance.pk %}"
                                onclick="return confirm('ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
                                style="font-size: 0.9em; color: red;">
                                    ì‚¬ì§„ ì‚­ì œ
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <!-- ì™¼ìª½: í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ -->
                    <div style="flex: 1;">
                        {{ form.employee_id.label }} {{ form.employee_id }}<br>
                        {{ form.name.label }} {{ form.name }}<br>
                        {{ form.employment_type.label }} {{ form.employment_type }}<br>
                        {{ form.department.label }} {{ form.department }}<br>
                        {{ form.position.label }} {{ form.position }}<br>
                        {{ form.position_title.label }} {{ form.position_title }}<br>
                        {{ form.rank.label }} {{ form.rank }}<br>
                        {{ form.role.label }} {{ form.role }}<br>
                        <!-- ì§ê¸‰ ê¸°ì¤€ì¼ ì…ë ¥ -->
                        <label for="id_position_start_date">ì§ê¸‰ ê¸°ì¤€ì¼</label><br>
                        <input type="date" name="position_start_date" id="id_position_start_date"
                            value="{{ form.instance.position_start_date|date:'Y-m-d' }}"><br>
                        {{ form.years_worked.label }} {{ form.years_worked }}<br>
                        <!-- ì£¼ë¯¼ë²ˆí˜¸ ì…ë ¥ -->
                        <label for="id_ssn">{{ form.ssn.label }}</label>
                        <input type="text" id="id_ssn" name="ssn" value="{{ form.ssn.value|default:'' }}"><br>
                        <label for="id_birth_date">{{ form.birth_date.label }}</label>
                        {{ form.birth_date }}<br>                        
                        <label for="id_gender">{{ form.gender.label }}</label>
                        {{ form.gender }}<br>                        
                        <!-- ë‚˜ì´: ìë™ê³„ì‚° í‘œì‹œ -->
                        <label for="id_age">{{ form.age.label }}</label>
                        <input type="text" id="id_age" name="age" value="{{ form.age.value|default:'' }}" readonly><br>
                        {{ form.phone.label }} {{ form.phone }}<br>
                        {{ form.email.label }} {{ form.email }}<br>
                        {{ form.address.label }} {{ form.address }}<br>
                        {{ form.hire_date.label }} {{ form.hire_date }}<br>
                        {{ form.resign_date.label }} {{ form.resign_date }}<br>
                        <label for="id_status">{{ form.status.label }}</label>
                        {{ form.status }}

                        <div id="leave_fields" style="display: none; margin-top: 10px;">
                            {{ form.leave_type.label }} {{ form.leave_type }}<br>
                            <!-- íœ´ì§ ì‹œì‘ì¼ -->
                            <label for="id_leave_start_date">íœ´ì§ ì‹œì‘ì¼</label><br>
                            <input type="date" name="leave_start_date" id="id_leave_start_date"
                                value="{{ form.instance.leave_start_date|date:'Y-m-d' }}"><br>

                            <!-- íœ´ì§ ì¢…ë£Œì¼ -->
                            <label for="id_leave_end_date">íœ´ì§ ì¢…ë£Œì¼</label><br>
                            <input type="date" name="leave_end_date" id="id_leave_end_date"
                                value="{{ form.instance.leave_end_date|date:'Y-m-d' }}"><br>
                        </div>
                    </div>
                </div>
            </div>    

            <!-- íƒ­2: ê²½ë ¥ ë° í•™ë ¥ -->
            <div id="tab2" class="tab-content" style="display: none;">
                <h4>ê²½ë ¥</h4>
                <table id="career_table" border="1" style="width:100%; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>íšŒì‚¬ëª…</th><th>ë¶€ì„œ</th><th>ì§ê¸‰</th><th>ì§ì±…</th><th>ì…ì‚¬ì¼</th><th>í‡´ì‚¬ì¼</th><th>ì´ì§ì‚¬ìœ </th><th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in career_list %}
                        <tr>
                            <td><input type="text" name="career_company[]" value="{{ c.company }}"></td>
                            <td><input type="text" name="career_department[]" value="{{ c.department }}"></td>
                            <td><input type="text" name="career_rank[]" value="{{ c.rank }}"></td>
                            <td><input type="text" name="career_position[]" value="{{ c.position }}"></td>
                            <td><input type="date" name="career_start[]" value="{{ c.start_date|date:'Y-m-d' }}"></td>
                            <td><input type="date" name="career_end[]" value="{{ c.end_date|date:'Y-m-d' }}"></td>
                            <td><input type="text" name="career_reason[]" value="{{ c.reason }}"></td>
                            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" onclick="addCareerRow()">+ ê²½ë ¥ ì¶”ê°€</button>

                <h4>í•™ë ¥</h4>
                <table id="education_table" border="1" style="width:100%; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>í•™êµëª…</th><th>ì „ê³µ</th><th>ì…í•™ì¼</th><th>ì¡¸ì—…ì¼</th><th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for edu in education_list %}
                        <tr>
                            <td><input type="text" name="edu_school[]" value="{{ edu.school }}"></td>
                            <td><input type="text" name="edu_major[]" value="{{ edu.major }}"></td>
                            <td><input type="date" name="edu_start[]" value="{{ edu.start_date|date:'Y-m-d' }}"></td>
                            <td><input type="date" name="edu_end[]" value="{{ edu.end_date|date:'Y-m-d' }}"></td>
                            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" onclick="addEducationRow()">+ í•™ë ¥ ì¶”ê°€</button>

                <h4>ìê²©ì‚¬í•­</h4>
                <table id="cert_table" border="1" style="width:100%; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>ìê²©ì¦ëª…</th><th>ë“±ê¸‰</th><th>ì·¨ë“ì¼</th><th>ë§Œë£Œì¼</th><th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cert in cert_list %}
                        <tr>
                            <td><input type="text" name="cert_name[]" value="{{ cert.name }}"></td>
                            <td><input type="text" name="cert_level[]" value="{{ cert.level }}"></td>
                            <td><input type="date" name="cert_acquired[]" value="{{ cert.acquired_date|date:'Y-m-d' }}"></td>
                            <td><input type="date" name="cert_expiry[]" value="{{ cert.expiry_date|date:'Y-m-d' }}"></td>
                            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" onclick="addCertRow()">+ ìê²©ì‚¬í•­ ì¶”ê°€</button>
            </div>
            
            <!-- íƒ­3: ì—°ë´‰ ë° ê³„ì¢Œì •ë³´ -->
            <div id="tab3" class="tab-content" style="display: none;">
                <h4>ì—°ë´‰ ë° ê³„ì¢Œì •ë³´</h4>
                <table border="1" style="width:100%; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>ì—°ë´‰</th>
                            <th>ì›”ê¸‰ì—¬</th>
                            <th>ì€í–‰ì½”ë“œ</th>
                            <th>ì€í–‰ëª…</th>
                            <th>ê³„ì¢Œë²ˆí˜¸</th>
                            <th>ì˜ˆê¸ˆì£¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" name="annual_salary" value="{% if salary_info %}{{ salary_info.annual_salary }}{% endif %}"></td>
                            <td><input type="number" name="monthly_salary" value="{% if salary_info %}{{ salary_info.monthly_salary }}{% endif %}"></td>

                            <!-- ğŸ‘‡ ì´ ë¶€ë¶„ì´ ì€í–‰ì½”ë“œ ë° ì€í–‰ëª… -->
                            <td>
                                <select name="bank_code" id="bank_code_select">
                                    <option value="">-- ì„ íƒ --</option>
                                    {% for code, name in bank_map %}
                                    <option value="{{ code }}">{{ code }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" name="bank_name" id="bank_name_input"
                                    value="{% if salary_info %}{{ salary_info.bank_name }}{% endif %}" readonly>
                            </td>

                            <td><input type="text" name="account_number" value="{% if salary_info %}{{ salary_info.account_number }}{% endif %}"></td>
                            <td><input type="text" name="account_holder" value="{% if salary_info %}{{ salary_info.account_holder }}{% endif %}"></td>
                        </tr>
                    </tbody>
                </table>
                <h4>ê¸‰ì—¬ ìƒì„¸ í•­ëª©</h4>
                <table border="1" style="width: 100%; margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th>ê¸°ë³¸ê¸‰</th>
                            <th>ê³ ì •ì—°ì¥ìˆ˜ë‹¹</th>
                            <th>ì‹ëŒ€</th>
                            <th>ì§ì±…ìˆ˜ë‹¹</th>
                            <th>ìê°€ìš´ì „ë³´ì¡°ê¸ˆ</th>
                            <th>ìœ¡ì•„ìˆ˜ë‹¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" name="base_salary" value="{% if salary_info %}{{ salary_info.base_salary }}{% endif %}"></td>
                            <td><input type="number" name="fixed_overtime_pay" value="{% if salary_info %}{{ salary_info.fixed_overtime_pay }}{% endif %}"></td>
                            <td><input type="number" name="meal_allowance" value="{% if salary_info %}{{ salary_info.meal_allowance }}{% endif %}"></td>
                            <td><input type="number" name="duty_allowance" value="{% if salary_info %}{{ salary_info.duty_allowance }}{% endif %}"></td>
                            <td><input type="number" name="commute_allowance" value="{% if salary_info %}{{ salary_info.commute_allowance }}{% endif %}"></td>
                            <td><input type="number" name="childcare_allowance" value="{% if salary_info %}{{ salary_info.childcare_allowance }}{% endif %}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
          
            <br>
            <div style="text-align: center; margin-top: 10px;">
                <button type="submit" style="position: relative; left: -415px;">
                    {% if form.instance.pk %}ìˆ˜ì •í•˜ê¸°{% else %}ë“±ë¡í•˜ê¸°{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

</body>
</html>

<!-- íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
    }
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ssnInput = document.getElementById("id_ssn");
        const birthDateInput = document.getElementById("id_birth_date");
    
        ssnInput.addEventListener("input", function () {
            let value = ssnInput.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ
    
            // ìë™ í•˜ì´í”ˆ ì‚½ì…
            if (value.length > 6) {
                value = value.slice(0, 6) + '-' + value.slice(6, 13);
            }
            ssnInput.value = value;
    
            // ìƒë…„ì›”ì¼ ìë™ ì…ë ¥
            const digits = value.replace('-', '');
            if (digits.length >= 7) {
                const yy = digits.slice(0, 2);
                const mm = digits.slice(2, 4);
                const dd = digits.slice(4, 6);
                const genderCode = digits.charAt(6);
                let century = (genderCode === '3' || genderCode === '4') ? '20' : '19';
                const fullDate = `${century}${yy}-${mm}-${dd}`;
    
                if (isValidDate(fullDate)) {
                    birthDateInput.value = fullDate;
                }
            }
        });
    
        function isValidDate(dateStr) {
            const date = new Date(dateStr);
            return !isNaN(date.getTime()) && dateStr === date.toISOString().slice(0, 10);
        }
    });
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const statusField = document.getElementById("id_status");
        const leaveFields = document.getElementById("leave_fields");
        const resignDateInput = document.getElementById("id_resign_date");
    
        // íœ´ì§ ì„ íƒ ì‹œ íœ´ì§ ì…ë ¥ì¹¸ í‘œì‹œ
        function toggleLeaveFields() {
            if (statusField.value === "íœ´ì§") {
                leaveFields.style.display = "block";
            } else {
                leaveFields.style.display = "none";
            }
        }
    
        // í‡´ì§ì¼ ì…ë ¥ ì‹œ ìƒíƒœ ìë™ í‡´ì§
        function autoSetStatusFromResignDate() {
            if (resignDateInput.value) {
                statusField.value = "í‡´ì§";
                leaveFields.style.display = "none";  // íœ´ì§ì¹¸ë„ ìˆ¨ê¹€
            }
        }
    
        // ì´ë²¤íŠ¸ ì—°ê²°
        statusField.addEventListener("change", toggleLeaveFields);
        resignDateInput.addEventListener("input", autoSetStatusFromResignDate);
    
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
        toggleLeaveFields();
        autoSetStatusFromResignDate();
    });
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const posStartInput = document.getElementById("id_position_start_date");
        const yearsField = document.getElementById("id_years_worked");
    
        function updateYearsWorked() {
            const posStartValue = posStartInput.value;
            if (posStartValue) {
                const startYear = new Date(posStartValue).getFullYear();
                const currentYear = new Date().getFullYear();
                const years = currentYear - startYear + 1;
                yearsField.value = years > 0 ? years : 1;
            }
        }
    
        posStartInput.addEventListener("change", updateYearsWorked);
        updateYearsWorked();  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê³„ì‚°
    });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('id_photo');
        const preview = document.getElementById('preview');
    
        if (input) {
            input.addEventListener('change', function () {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
    </script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ssnInput = document.getElementById("id_ssn");
        const genderInput = document.getElementById("id_gender");
    
        ssnInput.addEventListener("input", function () {
            const value = ssnInput.value.replace(/[^0-9]/g, '');
            if (value.length >= 7) {
                const genderCode = parseInt(value.charAt(6));
                if ([1, 3].includes(genderCode)) {
                    genderInput.value = "ë‚¨";
                } else if ([2, 4].includes(genderCode)) {
                    genderInput.value = "ì—¬";
                } else {
                    genderInput.value = "";
                }
            } else {
                genderInput.value = "";
            }
        });
    });
    </script>

<script>
    function addCareerRow() {
        const row = `<tr>
            <td><input type="text" name="career_company[]"></td>
            <td><input type="text" name="career_department[]"></td>
            <td><input type="text" name="career_rank[]"></td>
            <td><input type="text" name="career_position[]"></td>
            <td><input type="date" name="career_start[]"></td>
            <td><input type="date" name="career_end[]"></td>
            <td><input type="text" name="career_reason[]"></td>
            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
        </tr>`;
        document.querySelector("#career_table tbody").insertAdjacentHTML("beforeend", row);
    }
    
    function addEducationRow() {
        const row = `<tr>
            <td><input type="text" name="edu_school[]"></td>
            <td><input type="text" name="edu_major[]"></td>
            <td><input type="date" name="edu_start[]"></td>
            <td><input type="date" name="edu_end[]"></td>
            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
        </tr>`;
        document.querySelector("#education_table tbody").insertAdjacentHTML("beforeend", row);
    }
    
    function addCertRow() {
        const row = `<tr>
            <td><input type="text" name="cert_name[]"></td>
            <td><input type="text" name="cert_level[]"></td>
            <td><input type="date" name="cert_acquired[]"></td>
            <td><input type="date" name="cert_expiry[]"></td>
            <td><button type="button" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
        </tr>`;
        document.querySelector("#cert_table tbody").insertAdjacentHTML("beforeend", row);
    }
    </script>

<script>
    const bankMap = {
        '004': 'êµ­ë¯¼ì€í–‰',
        '011': 'ë†í˜‘ì€í–‰',
        '020': 'ìš°ë¦¬ì€í–‰',
        '088': 'ì‹ í•œì€í–‰',
        '081': 'í•˜ë‚˜ì€í–‰',
        '003': 'ê¸°ì—…ì€í–‰',
        '023': 'SCì œì¼ì€í–‰',
        '027': 'í•œêµ­ì”¨í‹°ì€í–‰',
        '039': 'ê²½ë‚¨ì€í–‰',
        '034': 'ê´‘ì£¼ì€í–‰'
    };

    document.addEventListener('DOMContentLoaded', function () {
        const codeSelect = document.getElementById('bank_code_select');
        const nameInput = document.getElementById('bank_name_input');

        codeSelect.addEventListener('change', function () {
            const selectedCode = this.value;
            nameInput.value = bankMap[selectedCode] || '';
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rrnInput = document.getElementById("id_ssn");
        const ageInput = document.getElementById("id_age");
    
        rrnInput.addEventListener("input", function () {
            const raw = rrnInput.value.replace(/-/g, '');
            if (raw.length >= 7) {
                const yy = parseInt(raw.slice(0, 2));
                const mm = parseInt(raw.slice(2, 4));
                const dd = parseInt(raw.slice(4, 6));
                const code = raw[6];
    
                let year = (code === '1' || code === '2') ? 1900 + yy :
                           (code === '3' || code === '4') ? 2000 + yy : null;
                if (!year) {
                    ageInput.value = '';
                    return;
                }
    
                const today = new Date();
                let age = today.getFullYear() - year;
                if ((today.getMonth() + 1 < mm) || ((today.getMonth() + 1 === mm) && today.getDate() < dd)) {
                    age--;
                }
    
                if (!isNaN(age)) {
                    ageInput.value = age;
                } else {
                    ageInput.value = '';
                }
            } else {
                ageInput.value = '';
            }
        });
    });
    </script>
    
    